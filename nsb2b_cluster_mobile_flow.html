<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‚Ä¢ ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÑ‡∏î‡πâ ‚Ä¢ ‡∏Ñ‡∏•‡∏±‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πå ‚Ä¢ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‚Ä¢ ‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ Excel</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <!-- PapaParse for CSV -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root {
      --orange: #f97316;
      --orange-600: #ea580c;
      --bg: #ffffff;
      --muted: #6b7280;
      --border: #e5e7eb;
    }
    html, body { height: 100%; margin: 0; background: var(--bg); }
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, 'Prompt', Arial, sans-serif; color: #111827; }
    #topbar {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      padding: 12px;
      border-bottom: 1px solid var(--border);
      background: #fff;
    }
    @media (min-width: 880px) {
      #topbar { grid-template-columns: 1fr 1fr; align-items: start; }
    }
    .row { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .grow { flex: 1 1 220px; }
    #map { height: calc(100% - 318px); }
    @media (min-width: 880px) { #map { height: calc(100% - 230px); } }

    .btn, .file, input[type="text"], textarea, input[type="tel"], input[type="file"] {
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #fff;
      font-size: 15px;
      line-height: 1.2;
    }
    textarea { resize: vertical; min-height: 40px; }
    .btn { cursor: pointer; font-weight: 650; }
    .btn.primary { background: var(--orange); color: white; border-color: var(--orange); }
    .btn.ghost { background: #fff; color: #111827; }
    .btn:active { transform: translateY(1px); }
    .file { display: inline-block; cursor: pointer; font-weight: 650; }
    .hint { color: var(--muted); font-size: 13px; }
    .badge {
      display: inline-block; padding: 4px 8px; border-radius: 9999px;
      background: #fff7ed; border: 1px solid #fed7aa; color: #7c2d12; font-size: 12px;
    }
    .sep { height: 1px; background: var(--border); margin: 6px 0; grid-column: 1 / -1; }
    .section-title { font-weight: 800; color: #111827; font-size: 14px; }

    /* Popup table */
    .popup-table { border-collapse: collapse; font-size: 12px; }
    .popup-table td { border-top: 1px solid var(--border); padding: 4px 6px; vertical-align: top; }
    .popup-table td:first-child { color: #6b7280; font-weight: 600; white-space: nowrap; }
    .photo { max-width: 220px; max-height: 220px; border-radius: 10px; display: block; margin-top: 6px; border:1px solid var(--border); }
    .link { color: var(--orange-600); text-decoration: none; font-weight: 600; }
    .link:hover { text-decoration: underline; }

    /* Simple orange accents for clusters */
    .marker-cluster-small { background-color: rgba(249, 115, 22, 0.4); }
    .marker-cluster-small div { background-color: rgba(249, 115, 22, 0.8); color:#fff; }
    .marker-cluster-medium { background-color: rgba(249, 115, 22, 0.5); }
    .marker-cluster-medium div { background-color: rgba(249, 115, 22, 0.85); color:#fff; }
    .marker-cluster-large { background-color: rgba(249, 115, 22, 0.6); }
    .marker-cluster-large div { background-color: rgba(234, 88, 12, 0.95); color:#fff; }
  </style>
</head>
<body>
  <div id="topbar">
    <div class="row">
      <label class="file">
        ‚¨áÔ∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV (‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏°‡∏∏‡∏î)
        <input id="file" type="file" accept=".csv" style="display:none" />
      </label>
      <button id="fit" class="btn ghost">üó∫Ô∏è ‡∏ã‡∏π‡∏°‡∏û‡∏≠‡∏î‡∏µ‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏∏‡∏î</button>
      <span id="counter" class="badge">‡∏´‡∏°‡∏∏‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: 0</span>
      <span class="hint">* ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á: Latitude/Lat, Longitude/Lon/Lng</span>
    </div>

    <div class="sep"></div>

    <div class="row">
      <span class="section-title">üìç ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)</span>
      <span class="hint">‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï GPS ‡∏ö‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</span>
    </div>

    <div class="row">
      <button id="locate" class="btn">üìç ‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</button>
      <input id="lat" class="grow" type="text" placeholder="Latitude" readonly />
      <input id="lon" class="grow" type="text" placeholder="Longitude" readonly />
    </div>
    <div class="row">
      <input id="gmaps" class="grow" type="text" placeholder="Google Maps Link ‡∏à‡∏∞‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥" readonly />
      <button id="copyLink" class="btn ghost">üîó ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå</button>
    </div>
    <div class="row" style="align-items:flex-start">
      <textarea id="details" class="grow" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‚Ä¶ (‡πÄ‡∏ä‡πà‡∏ô ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏¢/‡πÇ‡∏ô‡πâ‡∏ï)"></textarea>
      <label class="file">
        üìé ‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ
        <input id="photo" type="file" accept="image/*" capture="environment" style="display:none" />
      </label>
      <span id="photoName" class="hint"></span>
    </div>
    <div class="row">
      <button id="save" class="btn primary">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏±‡∏á‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</button>
      <button id="send" class="btn primary">üì§ ‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ Excel (Flow)</button>
      <button id="export" class="btn ghost">‚¨áÔ∏è ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV</button>
      <button id="clear" class="btn ghost">üßπ ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</button>
      <span id="status" class="hint"></span>
    </div>
  </div>

  <div id="map"></div>

  <script>
    // ===== Config: ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á Power Automate Flow ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà =====
    const FLOW_URL = "https://5a1c2d740043e072baa147741b6585.82.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/72fe4f8d63de43458a586604820694e4/triggers/manual/paths/invoke?api-version=1";

    // ===== Map setup =====
    const map = L.map('map');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    map.setView([13.736, 100.523], 6);

    const cluster = L.markerClusterGroup({
      showCoverageOnHover: false,
      maxClusterRadius: 50
    }).addTo(map);
    let currentBounds = null;

    // ===== Helpers =====
    const LS_KEY = "nsb2b_points_v3";
    const $ = (sel) => document.querySelector(sel);
    const toNum = (v) => {
      if (v === null || v === undefined) return NaN;
      let s = ('' + v).trim().replace(',', '.').replace(/^"+|"+$/g, '');
      return parseFloat(s);
    };
    const escapeHtml = (str) => String(str)
      .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;').replace(/'/g,'&#039;');

    function googleMapsLink(lat, lon) {
      if (isNaN(lat) || isNaN(lon)) return "";
      return `https://www.google.com/maps?q=${lat},${lon}`;
    }

    function fitBounds() {
      if (currentBounds) map.fitBounds(currentBounds, { padding: [40, 40] });
    }

    // Image compression to save localStorage space
    async function readImageAsDataURL(file, maxW = 1280, maxH = 1280, quality = 0.85) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let { width, height } = img;
            const ratio = Math.min(maxW / width, maxH / height, 1);
            width = Math.round(width * ratio);
            height = Math.round(height * ratio);
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            try {
              const dataUrl = canvas.toDataURL('image/jpeg', quality);
              resolve(dataUrl);
            } catch (e) { resolve(reader.result); } // fallback original
          };
          img.onerror = reject;
          img.src = reader.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    function popupHTML(rec) {
      let html = '<table class="popup-table">';
      html += `<tr><td>Latitude</td><td>${escapeHtml(rec.Latitude)}</td></tr>`;
      html += `<tr><td>Longitude</td><td>${escapeHtml(rec.Longitude)}</td></tr>`;
      if (rec.GoogleMapsURL) {
        html += `<tr><td>Map</td><td><a class="link" target="_blank" href="${escapeHtml(rec.GoogleMapsURL)}">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô Google Maps</a></td></tr>`;
      }
      if (rec.Details) {
        html += `<tr><td>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</td><td>${escapeHtml(rec.Details)}</td></tr>`;
      }
      if (rec.CreatedAt) {
        const d = new Date(rec.CreatedAt);
        html += `<tr><td>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠</td><td>${d.toLocaleString()}</td></tr>`;
      }
      html += '</table>';
      if (rec.PhotoDataURL) {
        html += `<img class="photo" src="${rec.PhotoDataURL}" alt="‡∏£‡∏π‡∏õ‡πÅ‡∏ô‡∏ö" />`;
      }
      return html;
    }

    function addPoints(records, fit=true) {
      let bounds = [];
      let added = 0;
      for (const rec of records) {
        if (!rec) continue;
        const lat = toNum(rec.Latitude || rec.Lat);
        const lon = toNum(rec.Longitude || rec.Lon || rec.Lng);
        if (isNaN(lat) || isNaN(lon)) continue;
        const marker = L.marker([lat, lon]);
        marker.bindPopup(popupHTML(rec));
        cluster.addLayer(marker);
        bounds.push([lat, lon]);
        added++;
      }
      if (added && fit) {
        currentBounds = L.latLngBounds(bounds);
        map.fitBounds(currentBounds, { padding: [40, 40] });
      }
      updateCounter();
      return added;
    }

    function updateCounter() {
      const local = readLocal();
      const layers = cluster.getLayers().length;
      $('#counter').textContent = `‡∏´‡∏°‡∏∏‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${layers}`;
      $('#status').textContent = `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á: ${local.length} ‡∏à‡∏∏‡∏î`;
    }

    function readLocal() {
      try { return JSON.parse(localStorage.getItem(LS_KEY) || '[]'); }
      catch { return []; }
    }
    function writeLocal(arr) {
      localStorage.setItem(LS_KEY, JSON.stringify(arr));
    }
    function refreshFromLocal() {
      const local = readLocal();
      addPoints(local, !!local.length);
    }

    // ===== UI events =====
    $('#fit').addEventListener('click', fitBounds);

    // CSV import (from file only)
    $('#file').addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      Papa.parse(file, {
        header: true, skipEmptyLines: true, encoding: "UTF-8",
        complete: (results) => {
          cluster.clearLayers();
          addPoints(results.data || []);
        }
      });
    });

    // Locate
    $('#locate').addEventListener('click', () => {
      if (!navigator.geolocation) {
        alert('‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Geolocation');
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const { latitude, longitude } = pos.coords;
          $('#lat').value = latitude.toFixed(6);
          $('#lon').value = longitude.toFixed(6);
          const link = googleMapsLink(latitude.toFixed(6), longitude.toFixed(6));
          $('#gmaps').value = link;
          map.setView([latitude, longitude], 17);
        },
        (err) => alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: ' + err.message),
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    });

    // Copy link
    $('#copyLink').addEventListener('click', async () => {
      const link = $('#gmaps').value.trim();
      if (!link) return;
      try { await navigator.clipboard.writeText(link); $('#status').textContent = '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏•‡πâ‡∏ß'; }
      catch { $('#status').textContent = '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'; }
      setTimeout(()=>$('#status').textContent='', 1500);
    });

    // Photo input
    $('#photo').addEventListener('change', () => {
      const f = $('#photo').files?.[0];
      $('#photoName').textContent = f ? f.name : '';
    });

    async function buildRecordFromForm() {
      const latV = $('#lat').value.trim();
      const lonV = $('#lon').value.trim();
      const lat = toNum(latV), lon = toNum(lonV);
      if (isNaN(lat) || isNaN(lon)) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î ‚Äú‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‚Äù ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏™‡πà‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        return null;
      }
      let photoDataURL = '';
      const f = $('#photo').files?.[0];
      if (f) {
        try { photoDataURL = await readImageAsDataURL(f); }
        catch { /* ignore */ }
      }
      return {
        Latitude: latV,
        Longitude: lonV,
        GoogleMapsURL: googleMapsLink(latV, lonV),
        Details: $('#details').value.trim(),
        PhotoDataURL: photoDataURL,
        CreatedAt: new Date().toISOString()
      };
    }

    // Save locally
    function resetAfterSave() {
      $('#details').value = '';
      $('#photo').value = '';
      $('#photoName').textContent = '';
    }
    function toast(msg) {
      $('#status').textContent = msg;
      setTimeout(()=>$('#status').textContent='', 1500);
    }
    $('#save').addEventListener('click', async () => {
      const rec = await buildRecordFromForm();
      if (!rec) return;
      const local = readLocal();
      local.push(rec);
      writeLocal(local);
      addPoints([rec], false);
      currentBounds = cluster.getBounds();
      updateCounter();
      resetAfterSave();
      toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß');
    });

    // Send to Flow
    $('#send').addEventListener('click', async () => {
      if (!FLOW_URL || FLOW_URL.startsWith('PASTE_')) {
        alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á Flow');
        return;
      }
      const rec = await buildRecordFromForm();
      if (!rec) return;
      try {
        const res = await fetch(FLOW_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(rec)
        });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json().catch(()=>({}));
        toast('‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ Excel ‡πÅ‡∏•‡πâ‡∏ß');
        // Optional: auto-save locally too
        const local = readLocal(); local.push(rec); writeLocal(local);
        addPoints([rec], false); currentBounds = cluster.getBounds(); updateCounter(); resetAfterSave();
      } catch (err) {
        alert('‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ Excel ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);
      }
    });

    // Export CSV (no images to keep file small)
    $('#export').addEventListener('click', () => {
      const local = readLocal();
      if (!local.length) { alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á'); return; }
      const slim = local.map(({Latitude,Longitude,GoogleMapsURL,Details,CreatedAt}) =>
        ({Latitude,Longitude,GoogleMapsURL,Details,CreatedAt})
      );
      const csv = Papa.unparse(slim);
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'local_points.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // Clear
    $('#clear').addEventListener('click', () => {
      if (!confirm('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ?')) return;
      localStorage.removeItem(LS_KEY);
      cluster.clearLayers();
      currentBounds = null;
      map.setView([13.736, 100.523], 6);
      updateCounter();
    });

    // First load
    function readLocal() { try { return JSON.parse(localStorage.getItem(LS_KEY) || '[]'); } catch { return []; } }
    function writeLocal(arr) { localStorage.setItem(LS_KEY, JSON.stringify(arr)); }
    function refreshFromLocal() { const local = readLocal(); addPoints(local, !!local.length); }
    refreshFromLocal();
  </script>
</body>
</html>
