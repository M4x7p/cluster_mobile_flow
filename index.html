<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>NSB2B ‚Ä¢ ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà + ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‚Ä¢ ‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ Excel (Flow)</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.js"></script>

  <!-- PapaParse for CSV -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root {
      --orange: #f97316;
      --orange-600: #ea580c;
      --bg: #ffffff;
      --muted: #6b7280;
      --border: #e5e7eb;
    }
    html, body { height: 100%; margin: 0; background: var(--bg); }
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, 'Prompt', Arial, sans-serif; color: #111827; }
    #topbar {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      padding: 12px;
      border-bottom: 1px solid var(--border);
      background: #fff;
    }
    @media (min-width: 880px) {
      #topbar { grid-template-columns: 1fr 1fr; align-items: start; }
    }
    .row { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .grow { flex: 1 1 220px; }
    #map { height: calc(100% - 360px); }
    @media (min-width: 880px) { #map { height: calc(100% - 260px); } }

    .btn, .file, input[type="text"], textarea, input[type="file"] {
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #fff;
      font-size: 15px;
      line-height: 1.2;
    }
    textarea { resize: vertical; min-height: 40px; }
    .btn { cursor: pointer; font-weight: 650; }
    .btn.primary { background: var(--orange); color: white; border-color: var(--orange); }
    .btn.ghost { background: #fff; color: #111827; }
    .btn:active { transform: translateY(1px); }
    .file { display: inline-block; cursor: pointer; font-weight: 650; }
    .hint { color: var(--muted); font-size: 13px; }
    .badge {
      display: inline-block; padding: 4px 8px; border-radius: 9999px;
      background: #fff7ed; border: 1px solid #fed7aa; color: #7c2d12; font-size: 12px;
    }
    .sep { height: 1px; background: var(--border); margin: 6px 0; grid-column: 1 / -1; }
    .section-title { font-weight: 800; color: #111827; font-size: 14px; }

    .popup-table { border-collapse: collapse; font-size: 12px; }
    .popup-table td { border-top: 1px solid var(--border); padding: 4px 6px; vertical-align: top; }
    .popup-table td:first-child { color: #6b7280; font-weight: 600; white-space: nowrap; }
    .photo { max-width: 220px; max-height: 220px; border-radius: 10px; display: block; margin-top: 6px; border:1px solid var(--border); }
    .link { color: var(--orange-600); text-decoration: none; font-weight: 600; }
    .link:hover { text-decoration: underline; }

    .marker-cluster-small { background-color: rgba(249, 115, 22, 0.4); }
    .marker-cluster-small div { background-color: rgba(249, 115, 22, 0.8); color:#fff; }
    .marker-cluster-medium { background-color: rgba(249, 115, 22, 0.5); }
    .marker-cluster-medium div { background-color: rgba(249, 115, 22, 0.85); color:#fff; }
    .marker-cluster-large { background-color: rgba(234, 88, 12, 0.95); color:#fff; }

    .danger { color: #b91c1c; font-weight: 700; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 12px; background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 6px; padding: 2px 6px; }
  </style>
</head>
<body>
  <div id="topbar">
    <div class="row">
      <label class="file">
        ‚¨áÔ∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV (‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏°‡∏∏‡∏î)
        <input id="file" type="file" accept=".csv" style="display:none" />
      </label>
      <button id="fit" class="btn ghost">üó∫Ô∏è ‡∏ã‡∏π‡∏°‡∏û‡∏≠‡∏î‡∏µ‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏∏‡∏î</button>
      <button id="settings" class="btn ghost">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
      <span id="counter" class="badge">‡∏´‡∏°‡∏∏‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: 0</span>
      <span class="hint">* ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á: Latitude/Lat, Longitude/Lon/Lng</span>
    </div>

    <div class="sep"></div>

    <div class="row">
      <span class="section-title">üìç ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)</span>
      <span class="hint">‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï GPS ‡∏ö‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</span>
    </div>

    <div class="row">
      <button id="locate" class="btn">üìç ‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</button>
      <input id="lat" class="grow" type="text" placeholder="Latitude" readonly />
      <input id="lon" class="grow" type="text" placeholder="Longitude" readonly />
    </div>
    <div class="row">
      <input id="gmaps" class="grow" type="text" placeholder="Google Maps Link ‡∏à‡∏∞‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥" readonly />
      <button id="copyLink" class="btn ghost">üîó ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå</button>
    </div>
    <div class="row" style="align-items:flex-start">
      <textarea id="details" class="grow" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‚Ä¶ (‡πÄ‡∏ä‡πà‡∏ô ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏¢/‡πÇ‡∏ô‡πâ‡∏ï)"></textarea>
      <label class="file">
        üìé ‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ
        <input id="photo" type="file" accept="image/*" capture="environment" style="display:none" />
      </label>
      <span id="photoName" class="hint"></span>
    </div>
    <div class="row">
      <button id="save" class="btn primary">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏±‡∏á‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</button>
      <button id="send" class="btn primary">üì§ ‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ Excel (Flow)</button>
      <button id="export" class="btn ghost">‚¨áÔ∏è ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV</button>
      <button id="clear" class="btn ghost">üßπ ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</button>
      <span id="status" class="hint"></span>
    </div>
    <div class="row">
      <span id="flowWarn" class="danger"></span>
    </div>
    <div class="row">
      <span class="hint">‡πÇ‡∏´‡∏°‡∏î payload: <span id="modeBadge" class="kbd">numbers</span> ‚Ä¢ ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà: <span id="destBadge" class="kbd">flow</span></span>
    </div>
  </div>

  <div id="map"></div>

  <script>
    // ===== Config persisted in localStorage =====
    const CFG_KEY = "nsb2b_cfg_v2";
    const DEFAULTS = {
      flowUrl: "https://5a1c2d740043e072baa147741b6585.82.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/72fe4f8d63de43458a586604820694e4/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=GgjyMXF1-bxZ9BGMvZ6aRt5HASwEir3zcnxQqY2gx0Y",
      apiKey: "",
      schemaMode: "numbers",      // "numbers" or "latlng"
      customHeaderName: "",        // e.g. "x-nsb2b-secret"
      customHeaderValue: "",
      proxyUrl: ""                 // optional: if set, will send to proxyUrl instead of flowUrl
    };
    function loadCfg() { try { return { ...DEFAULTS, ...(JSON.parse(localStorage.getItem(CFG_KEY) || "{}")) }; } catch { return { ...DEFAULTS }; } }
    function saveCfg(cfg) { localStorage.setItem(CFG_KEY, JSON.stringify(cfg)); }
    function setWarn() {
      const { flowUrl } = loadCfg();
      const el = document.getElementById('flowWarn');
      if (!flowUrl) {
        el.textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ FLOW URL (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ logic.azure.com + &sig=...)";
      } else if (!/logic\\.azure\\.com/i.test(flowUrl)) {
        el.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ environment.api.powerplatform.com (‡∏≠‡∏≤‡∏à‡∏ï‡∏¥‡∏î CORS/OAuth) ‚Üí ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô logic.azure.com";
      } else {
        el.textContent = "";
      }
    }
    function setBadges() {
      const { schemaMode, proxyUrl } = loadCfg();
      document.getElementById('modeBadge').textContent = schemaMode;
      document.getElementById('destBadge').textContent = proxyUrl ? "proxy" : "flow";
    }

    // ===== Map setup =====
    const map = L.map('map');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    map.setView([13.736, 100.523], 6);
    const cluster = L.markerClusterGroup({ showCoverageOnHover:false, maxClusterRadius:50 }).addTo(map);
    let currentBounds = null;

    // ===== Helpers =====
    const LS_KEY = "nsb2b_points_v5";
    const $ = (sel) => document.querySelector(sel);
    const toNum = (v) => {
      if (v === null || v === undefined) return NaN;
      let s = ('' + v).trim().replace(',', '.').replace(/^\"+|\"+$/g, '');
      return parseFloat(s);
    };
    const escapeHtml = (str) => String(str)
      .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;').replace(/'/g,'&#039;');

    function googleMapsLink(lat, lon) {
      if (isNaN(lat) || isNaN(lon)) return "";
      return `https://www.google.com/maps?q=${lat},${lon}`;
    }
    function fitBounds() { if (currentBounds) map.fitBounds(currentBounds, { padding:[40,40] }); }

    async function readImageAsDataURL(file, maxW=1024, maxH=1024, quality=0.75) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let {width, height} = img;
            const ratio = Math.min(maxW/width, maxH/height, 1);
            width = Math.round(width*ratio); height = Math.round(height*ratio);
            canvas.width = width; canvas.height = height;
            const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height);
            try { resolve(canvas.toDataURL('image/jpeg', quality)); } catch { resolve(reader.result); }
          };
          img.onerror = reject; img.src = reader.result;
        };
        reader.onerror = reject; reader.readAsDataURL(file);
      });
    }

    function popupHTML(rec) {
      let html = '<table class="popup-table">';
      html += `<tr><td>Latitude</td><td>${escapeHtml(rec.Latitude)}</td></tr>`;
      html += `<tr><td>Longitude</td><td>${escapeHtml(rec.Longitude)}</td></tr>`;
      if (rec.GoogleMapsURL) html += `<tr><td>Map</td><td><a class="link" target="_blank" href="${escapeHtml(rec.GoogleMapsURL)}">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô Google Maps</a></td></tr>`;
      if (rec.Details) html += `<tr><td>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</td><td>${escapeHtml(rec.Details)}</td></tr>`;
      if (rec.CreatedAt) { const d = new Date(rec.CreatedAt); html += `<tr><td>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠</td><td>${d.toLocaleString()}</td></tr>`; }
      html += '</table>';
      if (rec.PhotoDataURL) html += `<img class="photo" src="${rec.PhotoDataURL}" alt="‡∏£‡∏π‡∏õ‡πÅ‡∏ô‡∏ö" />`;
      return html;
    }

    function addPoints(records, fit=true) {
      let bounds = []; let added = 0;
      for (const rec of records) {
        if (!rec) continue;
        const lat = toNum(rec.Latitude || rec.Lat), lon = toNum(rec.Longitude || rec.Lon || rec.Lng);
        if (isNaN(lat) || isNaN(lon)) continue;
        const marker = L.marker([lat, lon]); marker.bindPopup(popupHTML(rec));
        cluster.addLayer(marker); bounds.push([lat, lon]); added++;
      }
      if (added && fit) { currentBounds = L.latLngBounds(bounds); map.fitBounds(currentBounds, { padding:[40,40] }); }
      updateCounter(); return added;
    }

    function updateCounter() {
      const local = readLocal(); const layers = cluster.getLayers().length;
      $('#counter').textContent = `‡∏´‡∏°‡∏∏‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${layers}`;
      $('#status').textContent = `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á: ${local.length} ‡∏à‡∏∏‡∏î`;
    }
    function readLocal() { try { return JSON.parse(localStorage.getItem(LS_KEY) || '[]'); } catch { return []; } }
    function writeLocal(arr) { localStorage.setItem(LS_KEY, JSON.stringify(arr)); }
    function refreshFromLocal() { const local = readLocal(); addPoints(local, !!local.length); }

    // ===== UI events =====
    $('#fit').addEventListener('click', fitBounds);

    $('#file').addEventListener('change', (e) => {
      const file = e.target.files?.[0]; if (!file) return;
      Papa.parse(file, { header:true, skipEmptyLines:true, encoding:"UTF-8",
        complete: (results) => { cluster.clearLayers(); addPoints(results.data || []); }
      });
    });

    $('#locate').addEventListener('click', () => {
      if (!navigator.geolocation) { alert('‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Geolocation'); return; }
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const { latitude, longitude } = pos.coords;
          $('#lat').value = latitude.toFixed(6);
          $('#lon').value = longitude.toFixed(6);
          $('#gmaps').value = googleMapsLink(latitude.toFixed(6), longitude.toFixed(6));
          map.setView([latitude, longitude], 17);
        },
        (err) => alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: ' + err.message),
        { enableHighAccuracy:true, timeout:10000, maximumAge:0 }
      );
    });

    $('#copyLink').addEventListener('click', async () => {
      const link = $('#gmaps').value.trim(); if (!link) return;
      try { await navigator.clipboard.writeText(link); $('#status').textContent = '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏•‡πâ‡∏ß'; }
      catch { $('#status').textContent = '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'; }
      setTimeout(()=>$('#status').textContent='', 1500);
    });

    $('#photo').addEventListener('change', () => {
      const f = $('#photo').files?.[0]; $('#photoName').textContent = f ? f.name : '';
    });

    async function buildRecordFromForm() {
      const latV = $('#lat').value.trim(), lonV = $('#lon').value.trim();
      const lat = toNum(latV), lon = toNum(lonV);
      if (isNaN(lat) || isNaN(lon)) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î ‚Äú‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‚Äù ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏™‡πà‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); return null; }
      let photoDataURL = ''; const f = $('#photo').files?.[0];
      if (f) { try { photoDataURL = await readImageAsDataURL(f); } catch {} }
      return {
        Latitude: lat,             // number
        Longitude: lon,            // number
        GoogleMapsURL: googleMapsLink(lat, lon),
        Details: $('#details').value.trim(),
        PhotoDataURL: photoDataURL,
        CreatedAt: new Date().toISOString()
      };
    }
    function resetAfterSave() { $('#details').value=''; $('#photo').value=''; $('#photoName').textContent=''; }
    function toast(msg) { $('#status').textContent = msg; setTimeout(()=>$('#status').textContent='', 1500); }

    // ===== Sending =====
    function makePayload(rec) {
      const { schemaMode } = loadCfg();
      if (schemaMode === 'latlng') {
        // legacy/simple schema like: { latlng: "13.7:100.5", google: "...", details: "...", createdAt: "...", photo: "base64" }
        return {
          latlng: `${rec.Latitude}:${rec.Longitude}`,
          google: rec.GoogleMapsURL,
          details: rec.Details,
          createdAt: rec.CreatedAt,
          photo: rec.PhotoDataURL ? String(rec.PhotoDataURL).split(',').slice(1).join(',') : ""
        };
      }
      // default: numbers schema
      return rec;
    }

    async function fetchWithRetry(url, options, retries = 2, baseDelayMs = 800) {
      for (let attempt = 0; attempt <= retries; attempt++) {
        const res = await fetch(url, options).catch(err => ({ ok:false, status:0, text: async()=> String(err) }));
        if (res.ok) return res;
        const shouldRetry = [429, 500, 502, 503, 504].includes(res.status);
        if (!shouldRetry || attempt === retries) return res;
        const delay = baseDelayMs * Math.pow(2, attempt);
        await new Promise(r => setTimeout(r, delay));
      }
    }

    async function sendToFlow(rec) {
      const cfg = loadCfg();
      const url = (cfg.proxyUrl && cfg.proxyUrl.trim()) ? cfg.proxyUrl.trim() : cfg.flowUrl.trim();
      if (!url) throw new Error("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL");
      const headers = { 'Content-Type': 'application/json', 'Accept': 'application/json' };
      if (cfg.apiKey) headers['x-api-key'] = cfg.apiKey;
      if (cfg.customHeaderName && cfg.customHeaderValue) {
        headers[cfg.customHeaderName] = cfg.customHeaderValue;
      }
      const body = JSON.stringify(makePayload(rec));
      const res = await fetchWithRetry(url, { method:'POST', headers, body }, 2, 800);
      if (!res || !res.ok) {
        const txt = res ? (await res.text().catch(()=>'')) : 'no response';
        throw new Error(`HTTP ${res ? res.status : 0} ${txt}`);
      }
      return res.json().catch(()=> ({}));
    }

    // Buttons
    $('#save').addEventListener('click', async () => {
      const rec = await buildRecordFromForm(); if (!rec) return;
      const local = readLocal(); local.push(rec); writeLocal(local);
      addPoints([rec], false); currentBounds = cluster.getBounds(); updateCounter();
      resetAfterSave(); toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß');
    });

    $('#send').addEventListener('click', async () => {
      const rec = await buildRecordFromForm(); if (!rec) return;
      try {
        const data = await sendToFlow(rec);
        toast('‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ Excel ‡πÅ‡∏•‡πâ‡∏ß');
        const local = readLocal(); local.push(rec); writeLocal(local);
        addPoints([rec], false); currentBounds = cluster.getBounds(); updateCounter(); resetAfterSave();
      } catch (err) {
        alert('‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ Excel ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);
      }
    });

    $('#export').addEventListener('click', () => {
      const local = readLocal(); if (!local.length) { alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á'); return; }
      const slim = local.map(({Latitude,Longitude,GoogleMapsURL,Details,CreatedAt}) => ({Latitude,Longitude,GoogleMapsURL,Details,CreatedAt}));
      const csv = Papa.unparse(slim);
      const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob); const a = document.createElement('a');
      a.href = url; a.download = 'local_points.csv'; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    });

    $('#clear').addEventListener('click', () => {
      if (!confirm('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ?')) return;
      localStorage.removeItem(LS_KEY); cluster.clearLayers(); currentBounds = null; map.setView([13.736,100.523],6); updateCounter();
    });

    // Settings prompt (simple)
    document.getElementById('settings').addEventListener('click', () => {
      const cfg = loadCfg();
      const flowUrl = prompt("FLOW URL (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ logic.azure.com + &sig=...)", cfg.flowUrl);
      if (flowUrl === null) return;
      const apiKey = prompt("x-api-key (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ ‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á)", cfg.apiKey);
      if (apiKey === null) return;
      const schemaMode = prompt("payload mode: numbers ‡∏´‡∏£‡∏∑‡∏≠ latlng", cfg.schemaMode);
      if (schemaMode === null) return;
      const customHeaderName = prompt("Custom header name (‡πÄ‡∏ä‡πà‡∏ô x-nsb2b-secret) ‚Äì ‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ", cfg.customHeaderName);
      if (customHeaderName === null) return;
      const customHeaderValue = customHeaderName ? prompt("Custom header value", cfg.customHeaderValue) : "";
      if (customHeaderName && customHeaderValue === null) return;
      const proxyUrl = prompt("Proxy URL (‡πÄ‡∏ä‡πà‡∏ô Cloudflare Worker) ‚Äì ‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ", cfg.proxyUrl);

      saveCfg({
        flowUrl: (flowUrl||"").trim(),
        apiKey: (apiKey||"").trim(),
        schemaMode: (schemaMode||"numbers").toLowerCase().startsWith("latlng") ? "latlng" : "numbers",
        customHeaderName: (customHeaderName||"").trim(),
        customHeaderValue: (customHeaderValue||"").trim(),
        proxyUrl: (proxyUrl||"").trim()
      });
      setWarn();
      setBadges();
      toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß');
    });

    // First load
    refreshFromLocal();
    setWarn();
    setBadges();
  </script>
</body>
</html>
